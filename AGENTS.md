# 苏州园林数据可视化项目

## 目录约定

项目核心需求：[docs/项目需求.md](docs/项目需求.md)
项目实现方案：[docs/实现方案.md](docs/实现方案.md)

- ./dataset: 苏州园林数据和图片
- ./archived: 旧数据，禁止使用
- ./archived/VIS: 旧版可视化项目(A)，带有 高德 API 可供参考（索引文档：docs/OLD_VIS_INDEX.md）
- ./archived/web: 旧版可视化项目(B)，可供参考。
- ./docs: 项目相关文档
- DEPLOYMENT.md: Cloudflare 部署指南

唯一的真实数据源头：public/dataset/SuzhouGardenListFull.csv 和 public/dataset/images 中的图片（以园林名称命名的文件夹）。
当前目录下已经使用 `npm create vite@latest -- --template vue-ts` 创建好了 Vue3 + TypeScript + Vite 项目骨架。

## 开发指引

- 在所有开发过程中，必须严格遵循"项目核心需求"和"项目实现方案"中的各项规定，确保最终交付物符合预期要求。
- 任何 "项目核心需求" 和 "项目实现方案" 中表述不清、有歧义或存在冲突的地方，必须及时要求用户确认，避免任何理解偏差导致的开发错误。
- 每次修改完成后，都需要对 AGENTS.md 进行更新，记录当前的开发进度和下一步计划。
- 开发中不需要考虑节省 Token，优先保证输出内容的完整性和准确性。

## 环境提示

- 在 zsh 中使用 "setp" 这个命令可以设置代理环境变量（在 .zshrc 中已经配置好）。
- 当前目录中可以使用 uv 管理当前 Python 版本和虚拟环境(.venv/bin/activate)。
- 当前环境中已经安装好 npm，如需启动服务器、运行构建或安装新 Package，必须要求用户协助。
- 由于开发服务器运行可能导致终端阻塞，如有测试需求，请直接要求用户自行启动测试。

---

## 项目里程碑规划

### 里程碑 0：前期准备与环境配置 ✅

**目标**：完成开发环境配置，确保项目基础设施就绪

**任务清单**：

- [x] 初始化 Vue3 + Vite + TypeScript 项目骨架（已完成）
- [x] 安装核心依赖：Tailwind CSS、Pinia、ECharts、PapaParse、@amap/amap-jsapi-loader
- [x] 配置 Tailwind CSS（包括配置文件和样式入口）
- [x] 配置环境变量（创建 .env 文件，添加 VITE_AMAP_KEY）
- [x] 配置路径别名（tsconfig.json 和 vite.config.ts 中设置 @ 别名指向 src）
- [x] 验证开发服务器正常启动

**交付物**：

- ✅ 完整的 package.json 依赖清单
- ✅ 可运行的基础开发环境
- ✅ Tailwind CSS 配置完成（tailwind.config.js + postcss.config.js）
- ✅ 环境变量配置模板（.env + .env.example）
- ✅ 路径别名配置（@ -> src）

---

### 里程碑 1：数据层与类型系统 ✅

**目标**：建立数据加载、解析和类型定义体系，确保数据流通畅

**任务清单**：

- [x] 定义 TypeScript 类型接口（GardenData、Filters、NarrativeScene 等）
- [x] 实现 CSV 数据加载服务（services/dataLoader.ts）
- [x] 实现数据清洗与字段映射逻辑
  - 处理面积数值化
  - 处理文保单位级别空值（归为"未定级"）
  - 处理世界遗产空值（视为 FALSE）
  - 实现面积区间分箱逻辑
- [x] 实现派生字段计算（建造年代分类、面积区间等）
- [x] 搭建 Pinia Store 基础架构（store/index.ts、store/gardenStore.ts）
- [x] 在 Store 中实现数据状态管理
  - rawData（原始数据）
  - filteredData（过滤后数据，computed）
  - filters（筛选条件）
  - viewMode（概览/探索模式）
  - overviewNarrative（当前叙事场景）
  - selectedGarden（选中园林）
- [x] 实现统一过滤逻辑（Store getter）
- [x] 编写数据加载测试代码，验证数据正确加载

**交付物**：

- ✅ 完整的 TypeScript 类型定义文件 (src/types/index.ts)
- ✅ 可工作的数据加载与清洗模块 (src/services/dataLoader.ts)
- ✅ Pinia Store 状态管理架构 (src/stores/gardenStore.ts)
- ✅ 数据验证通过（108 条记录正确加载）
- ✅ 数据测试页面可正常显示统计信息

---

### 里程碑 2：基础布局与 UI 框架 ✅

**目标**：实现三栏式布局框架，建立模式切换机制

**任务清单**：

- [x] 设计并实现顶部导航栏组件（HeaderNav.vue）
  - 项目标题
  - 模式切换按钮（概览/探索）
- [x] 实现三栏式布局容器（MainLayout.vue）
  - 左侧操作区（宽度 320px）
  - 中间主视图（flex-1）
  - 右侧详情区（宽度 384px，仅探索模式显示）
- [x] 实现左侧操作区框架（LeftPanel.vue）
  - 概览模式：叙事场景选择器 + 场景筛选器容器
  - 探索模式：搜索框 + 多维筛选器容器
- [x] 实现中间主视图容器（MainView.vue）
  - 概览模式：图表网格容器
  - 探索模式：地图容器
- [x] 实现右侧详情区框架（RightPanel.vue，仅探索模式）
  - 空状态提示
  - 区域统计视图
  - 园林详情视图
- [x] 实现模式切换逻辑
  - Store 中的 viewMode 状态管理
  - 切换时保留筛选条件
  - UI 响应模式切换
- [x] 实现响应式布局样式（桌面端优先）
- [x] 修复类型系统（将 enum 改为 type 联合类型以兼容 erasableSyntaxOnly）

**交付物**：

- ✅ 完整的三栏式布局框架
- ✅ 可切换的概览/探索模式
- ✅ 基础 UI 组件库结构（HeaderNav、LeftPanel、MainView、RightPanel、MainLayout）
- ✅ 模式切换动画与状态管理
- ✅ 构建验证通过

---

### 里程碑 3：概览模式 - 叙事场景与图表 ✅

**目标**：实现概览模式的四个叙事场景及其对应的图表与表格

**任务清单**：

#### 3.1 指标卡与 KPI 组件

- [x] 设计并实现 KPI 指标卡组件（MetricCard.vue）
- [x] 实现核心指标计算逻辑（园林总数、开放率、世界遗产数、平均面积等）
- [x] 在概览模式左侧展示指标摘要

#### 3.2 叙事场景选择器

- [x] 实现叙事场景下拉选择组件（NarrativeSelector.vue）
- [x] 定义四个叙事场景配置
  - 空间集中与遗产核心
  - 历史谱系与认定节奏
  - 开放可达与权属/用途
  - 规模结构与资源配置
- [x] 实现场景切换逻辑

#### 3.3 通用图表组件封装

- [x] 封装 ECharts 基础容器组件（BaseChart.vue）
- [x] 实现柱状图组件（BarChart.vue）
- [x] 实现分层柱状图组件（StackedBarChart.vue）
- [x] 实现桑基图组件（SankeyChart.vue）
- [x] 实现直方图组件（HistogramChart.vue）

#### 3.4 场景 1：空间集中与遗产核心

- [x] 实现区县×文保单位级别分层柱状图
- [x] 实现区县园林数量/总面积柱状图
- [x] 实现文保等级构成条形图（替代原世界遗产分布图）
- [x] 实现世界遗产园林清单表格组件
- [x] 集成为完整场景视图组件（NarrativeScene1.vue）

#### 3.5 场景 2：历史谱系与认定节奏

- [x] 实现建设时期数量柱状图
- [x] 实现建造年代×文保单位级别分层柱状图
- [x] 实现公布批次×建造年代分层柱状图
- [x] 实现早期年代园林清单表格组件
- [x] 集成为完整场景视图组件（NarrativeScene2.vue）

#### 3.6 场景 3：开放可达与权属/用途

- [x] 实现权属性质→开放情况桑基图
- [x] 实现当前用途×开放情况分层柱状图
- [x] 实现区县×开放情况分层柱状图
- [x] 实现未开放园林清单表格组件
- [x] 集成为完整场景视图组件（NarrativeScene3.vue）

#### 3.7 场景 4：规模结构与资源配置

- [x] 实现面积区间直方图（按开放情况分层）
- [x] 实现区县平均/总面积柱状图
- [x] 实现建造年代平均面积柱状图
- [x] 实现面积 Top10 园林表格组件
- [x] 集成为完整场景视图组件（NarrativeScene4.vue）

#### 3.8 视觉编码统一化

- [x] 定义统一的配色方案（区县、文保级别、开放情况等）
- [x] 实现图表主题配置（theme.ts）
- [x] 应用统一视觉编码到所有图表

**交付物**：

- ✅ 完整的概览模式四个叙事场景
- ✅ 所有必需的图表组件（BaseChart、BarChart、StackedBarChart、SankeyChart、HistogramChart）
- ✅ 场景切换与叙事选择功能正常
- ✅ 统一的视觉编码体系（theme.ts）
- ✅ KPI 指标卡展示
- ✅ 构建验证通过

---

### 里程碑 4：探索模式 - 地图集成 ✅

**目标**：集成高德地图，实现行政区边界展示和园林点位标注

**任务清单**：

#### 4.1 地图基础设施

- [x] 实现地图加载服务（services/mapLoader.ts）
- [x] 使用 @amap/amap-jsapi-loader 动态加载 AMap JS API
- [x] 实现地图容器组件（MapView.vue）
- [x] 初始化地图实例，设置苏州市为中心
- [x] 配置地图控件（缩放、比例尺等）

#### 4.2 行政区边界展示

- [x] 使用 DistrictLayer 或 DistrictSearch 获取苏州市及区县边界
- [x] 实现行政区 polygon 渲染
- [x] 实现区县分级着色（基于园林数量或面积）
- [x] 实现行政区点击交互
- [x] 从 archived/VIS/suzhou_districts.json 复制并转换行政区边界数据到项目目录

#### 4.3 园林点位展示

- [x] 基于经纬度创建 Marker 标注
- [x] 实现自定义 Marker 样式（根据文保级别、开放情况着色）
- [x] 集成 MarkerClusterer 实现点位聚合
- [x] 实现聚合/散点模式切换
- [x] 实现点位点击事件处理

#### 4.4 地图信息弹窗

- [x] 实现点位点击弹窗（使用 AMap.InfoWindow）
- [x] 显示园林基础信息（名称、开放情况、地址、面积等）
- [x] 显示区县统计信息（区县名称、园林数量）

#### 4.5 地图与筛选联动

- [x] 监听 Store 中的 filteredData 变化
- [x] 动态更新地图点位集合
- [x] 实现地图数据联动（筛选更新地图显示）

**交付物**：

- ✅ 可工作的高德地图集成
- ✅ 行政区边界与园林点位正确展示
- ✅ 地图交互与联动功能正常
- ✅ 无 TypeScript 错误

---

### 里程碑 5：搜索与筛选功能 ✅

**目标**：实现全局筛选系统，支持多维度组合筛选

**任务清单**：

#### 5.1 筛选组件开发

- [x] 实现下拉选择筛选器（SelectFilter.vue）
- [x] 实现多选筛选器（MultiSelectFilter.vue）
- [x] 实现范围筛选器（RangeFilter.vue，用于面积区间）
- [x] 实现布尔筛选器（BooleanFilter.vue，用于世界遗产）
- [x] 搜索框已在里程碑 2 中完成（LeftPanel.vue）

#### 5.2 探索模式筛选器集成

- [x] 集成搜索框（按名称搜索）
- [x] 集成区县筛选器
- [x] 集成建造年代筛选器
- [x] 集成年代分类筛选器
- [x] 集成开放情况筛选器
- [x] 集成文保单位级别筛选器
- [x] 集成权属性质筛选器
- [x] 集成世界遗产筛选器
- [x] 集成当前用途筛选器
- [x] 集成公布批次筛选器
- [x] 集成面积区间筛选器
- [x] 实现清空筛选按钮

#### 5.3 筛选逻辑实现

- [x] 在 Store 中实现多维度组合筛选逻辑（已在里程碑 1 完成）
- [x] 实现搜索逻辑（名称模糊匹配，已在里程碑 1 完成）
- [x] 实现筛选结果缓存与优化（通过 computed 实现）
- [x] 实现筛选条件持久化（模式切换时保留，已在 Store 实现）

#### 5.4 筛选反馈与统计

- [x] 显示筛选结果数量
- [x] 显示当前生效的筛选标签
- [x] 实现快速清除单个筛选条件
- [x] 实现清空全部筛选条件

**交付物**：

- ✅ 完整的筛选组件库（MultiSelectFilter、SelectFilter、BooleanFilter、RangeFilter）
- ✅ 筛选器集成组件（ExploreFilters）
- ✅ 筛选标签组件（FilterTags）
- ✅ 多维度组合筛选功能正常
- ✅ 搜索功能正常（仅探索模式）
- ✅ 构建验证通过

---

### 里程碑 6：详情面板与信息展示 ✅

**目标**：实现探索模式的详情展示，支持园林详情和区域统计

**任务清单**：

#### 6.1 园林详情卡片

- [x] 实现园林详情卡片组件（集成到 RightPanel.vue）
- [x] 展示完整字段信息（名称、区县、地址、建造年代、面积、文保级别、权属性质、管理单位、保护状况、开放情况、当前用途、描述）
- [x] 实现图片展示功能
  - 按名称匹配 dataset/images 中的图片文件夹
  - 支持图片轮播或网格展示
  - 无图片时显示占位符
- [x] 实现详情卡片样式设计

#### 6.2 区域统计视图

- [x] 实现区域统计组件（集成到 RightPanel.vue）
- [x] 展示选中区县的园林列表（简表：名称、开放情况、权属性质）
- [x] 展示区域统计指标（总数、开放率、平均面积等）
- [x] 实现区域内园林点击跳转到详情

#### 6.3 右侧详情区状态管理

- [x] 实现详情区状态切换（空状态/区域统计/园林详情）
- [x] 监听地图点击事件，更新详情区内容
- [x] 实现详情区关闭按钮（返回空状态）

#### 6.4 图片加载与优化

- [x] 实现图片懒加载
- [x] 实现图片加载失败处理
- [x] 优化图片展示性能

**交付物**：

- ✅ 完整的详情展示功能
- ✅ 图片展示正常（按名称匹配）
- ✅ 区域统计与园林详情切换正常
- ✅ 构建验证通过

---

### 里程碑 7：交互优化与视觉完善

**目标**：优化用户体验，完善视觉设计，确保交互流畅，并补充新的可视化需求

**任务清单**：

#### 7.1 新增功能：区域统计雷达图与概览增强

- [x] 加载行政区划数据（SuzhouDistricts.csv，含人口与面积）并注入 Store
- [x] 实现雷达图组件（RadarChart.vue）
- [x] 计算可访问指数（基于人口与开放园林数）
- [x] 在右侧详情面板集成雷达图（展示人口、面积、园林数量、开放率、可访问指数）
- [x] 增强概览模式场景 1：将"区县园林数量"图表升级为"园林密度对比"（含每平方公里数量）
- [x] 增强概览模式场景 3：新增"区县人均开放资源"图表（含每万人开放园林数量）

#### 7.2 交互优化

- [x] 实现地图高亮联动（详情面板 → 地图）
- [x] 实现图表悬停提示优化（tooltip 内容丰富化）
- [x] 实现加载状态提示（loading spinner）
- [x] 实现错误状态提示（数据加载失败、地图加载失败等）

#### 7.3 视觉设计完善

- [x] 设计统一的配色方案
- [x] 设计图表样式（网格、坐标轴、标签等）
- [x] 设计卡片与面板阴影、边框样式
- [x] 设计按钮与交互元素样式
- [x] 调整字体大小与行高，确保可读性

#### 7.4 性能优化

- [x] 优化图表重绘性能
- [x] 优化地图 Marker 渲染性能（实现聚合/散点模式切换）
- [x] 优化打包体积

**交付物**：

- ✅ 统一的视觉风格（配色方案、图表样式、组件样式）
- ✅ 地图 Marker 渲染性能优化（聚合模式）
- ✅ 加载与错误状态提示
- ✅ 区域统计雷达图与概览增强（行政区划数据、雷达图、园林密度、人均开放资源）
- ✅ 交互体验优化（高亮联动、悬停提示）
- ✅ 图表重绘性能优化与打包体积优化

---

## 当前状态

**已完成**：

- 里程碑 0 - 前期准备与环境配置 ✅
- 里程碑 1 - 数据层与类型系统 ✅
- 里程碑 2 - 基础布局与 UI 框架 ✅
- 里程碑 3 - 概览模式叙事场景与图表 ✅
- 里程碑 4 - 探索模式地图集成 ✅
- 里程碑 5 - 搜索与筛选功能 ✅
- 里程碑 6 - 详情面板与信息展示 ✅
- 里程碑 7 - 交互优化与视觉完善 ✅

**当前进度**：所有里程碑已完成 🎉
**下一步**：项目已完成，可以进行部署或进一步的功能扩展

### 已完成工作简要总结

**里程碑 0：**
已完成 Vue3+Vite+TS 项目初始化，集成 Tailwind CSS、Pinia、ECharts、AMap 和 PapaParse 等核心依赖。配置了环境变量、路径别名及 Tailwind 主题色，确保开发环境与基础设施就绪。

**里程碑 1：**
建立了完整的 TypeScript 类型系统（含 GardenData、Filters 等），实现了 CSV 数据加载、清洗与派生字段计算服务。搭建了 Pinia Store 管理数据状态、筛选逻辑与视图模式，并成功验证了 108 条园林数据的正确加载与统计指标计算。

**里程碑 2：**
实现了完整的三栏式响应式布局框架，包括顶部导航栏（HeaderNav）、左侧操作区（LeftPanel）、中间主视图（MainView）、右侧详情区（RightPanel）和主布局容器（MainLayout）。成功实现了概览/探索模式的切换机制，包括状态管理、UI响应和切换动画。修复了类型系统问题（将enum改为type联合类型），构建验证通过。左侧面板根据模式显示不同内容（概览模式：叙事场景选择器；探索模式：搜索框），右侧详情区仅在探索模式显示并带有平滑过渡动画。

**里程碑 3：**
完成概览模式的全部四个叙事场景实现。建立了统一的视觉编码体系（theme.ts），定义了区县、文保级别、开放情况等维度的配色方案。实现了完整的图表组件库，包括BaseChart（ECharts基础容器）、BarChart（柱状图）、StackedBarChart（分层柱状图）、SankeyChart（桑基图）、HistogramChart（直方图）。实现了四个叙事场景组件：

- 场景1（空间集中与遗产核心）：展示区县×文保级别分布、区县园林数量/总面积、世界遗产分布及清单
- 场景2（历史谱系与认定节奏）：展示建设时期分布、建造年代×文保级别、公布批次×建造年代及早期园林清单
- 场景3（开放可达与权属/用途）：展示权属→开放桑基图、当前用途×开放情况、区县×开放情况及未开放园林清单
- 场景4（规模结构与资源配置）：展示面积区间分布、区县平均/总面积、建造年代平均面积及面积Top10清单
  实现了MetricCard组件和NarrativeSelector组件，左侧面板展示整体统计指标。所有图表支持响应式布局、交互联动和统一主题。

**里程碑 4：**
完成探索模式的高德地图集成（MapView.vue），主要实现要点：使用 services/mapLoader.ts 和 @amap/amap-jsapi-loader 动态加载 AMap JS API，负责地图初始化、控件、加载与错误管理；行政区边界从 archived/VIS 的 GeoJSON 导入并按园林数量做分级着色，支持区县点击/悬停及信息弹窗；园林点位采用自定义 Marker（配色来源 theme.ts）并集成 MarkerClusterer，支持聚合/散点切换与点位信息弹窗；通过监听 Store.filteredData 实现筛选联动，依据聚合模式切换渲染策略，并在组件卸载时清理 Markers/InfoWindow/地图实例。最后将 MapView 集成进 MainView 的探索模式。

**里程碑 5：**
完成探索模式的全局筛选系统，实现了多维度组合筛选功能。创建了完整的筛选器组件库（`MultiSelectFilter.vue`, `SelectFilter.vue`, `BooleanFilter.vue`, `RangeFilter.vue`）和集成组件 `ExploreFilters.vue`，支持区县、开放情况、文保级别、权属、年代、面积等多维度组合筛选。实现了 `FilterTags.vue` 展示和管理生效筛选条件。更新 `LeftPanel.vue` 集成搜索框、筛选器及结果统计，实现了筛选逻辑与 Store 的深度集成及持久化。

**里程碑 6：**
完成探索模式的详情面板与信息展示功能。创建了图片展示组件（GardenImageGallery.vue），支持从 `/dataset/images` 自动加载图片、轮播展示及懒加载。更新了 RightPanel 组件，实现了园林详情卡片（展示完整字段）和区域统计视图（包含智能统计指标显示和多维度 Badge 标签）。更新了 MapView 组件，实现了地图与详情区的深度交互联动：点击区县显示区域统计，点击点位显示园林详情。同时实现了智能区域遮罩显示，使行政区遮罩能与筛选器状态实时联动。

**里程碑 7：**
完成了区域统计雷达图、概览增强、地图高亮联动及打包体积优化。实现了行政区划数据加载与 Store 集成，创建了 RadarChart 组件展示区域综合指标（人口、面积、园林数量、开放率、可访问指数），并在概览模式中增强了园林密度与人均资源图表。实现了详情面板与地图的双向高亮联动，包括区县/园林高亮、自动视野缩放及聚合模式下的交互优化。修复了文保等级着色等 Bug，优化了 MapView 性能（移除深度代理）和图片懒加载策略。针对地图交互进行了深度优化，包括点击聚焦逻辑、聚合点点击处理及高亮状态保持。

**后续增强功能：**

- 在地图行政区遮罩上添加了美观的行政区名称标签（使用 AMap.Text），采用衬线字体和半透明文字阴影样式。标签在较大比例尺（缩放级别 ≤12）时显示，缩放较近时自动隐藏，与行政区遮罩显隐状态联动。

**下一步工作：**
